<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Parent Dashboard - School Portal</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f4f8; max-width: 700px; margin: 2em auto; color:#333; }
  h2 { border-bottom: 3px solid #3498db; padding-bottom: 0.5em; }
  label { font-weight: bold; margin-top: 1em; display: block; }
  select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #3498db; color: white; }
  .paid { color: green; font-weight: bold; }
  .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
</style>
</head>
<body>
  <div class="container">
    <h2>Parent Dashboard</h2>
    <div id="studentInfo"></div>
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th>Status</th>
          <th>Amount (₹)</th>
          <th>Bill</th>
        </tr>
      </thead>
      <tbody id="paymentTableBody"></tbody>
      <tfoot>
        <tr>
          <td><strong>Total</strong></td>
          <td></td>
          <td id="totalAmount"></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyClydUD7rDxZlNq8WdkoEOnfOmB3CPCTbk",
    authDomain: "fees-management-5edc0.firebaseapp.com",
    databaseURL: "https://fees-management-5edc0-default-rtdb.firebaseio.com",
    projectId: "fees-management-5edc0",
    storageBucket: "fees-management-5edc0.appspot.com",
    messagingSenderId: "1086040325830",
    appId: "1:1086040325830:web:976be3e78dbbc9550921c7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  async function loadStudentData(admissionNumber) {
    if (!admissionNumber) {
      document.getElementById('studentInfo').textContent = 'No Admission Number provided.';
      return;
    }
    try {
      const snapshot = await get(ref(db, 'students/' + admissionNumber));
      if (!snapshot.exists()) {
        document.getElementById('studentInfo').textContent = 'Student not found.';
        return;
      }
      const student = snapshot.val();

      document.getElementById('studentInfo').innerHTML = `
        <p><strong>Name:</strong> ${student.studentName}</p>
        <p><strong>Class:</strong> ${student.studentClass}</p>
        <p><strong>Batch:</strong> ${student.batch || student.studentBatch || '-'}</p>
        <p><strong>Admission Number:</strong> ${student.admissionNumber}</p>
        <p><strong>Parent Name:</strong> ${student.parentName}</p>
        <p><strong>Parent Phone:</strong> ${student.parentPhone}</p>`;

      const payments = student.payments || {};
      const months = Object.keys(payments).sort();
      let paidTotal = 0;
      const tbody = document.getElementById('paymentTableBody');
      tbody.innerHTML = '';

      if (months.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No payment history found.</td></tr>';
      } else {
        months.forEach(month => {
          const p = payments[month];
          if (!p.paid) return;  // Skip unpaid
          const status = '<span class="paid">Paid</span>';
          paidTotal += +p.amount || 0;
          const billBtn = `<button onclick="alert('Bill for ${student.studentName} - ${month}')">View Bill</button>`;

          tbody.innerHTML += `<tr>
            <td>${month}</td>
            <td>${status}</td>
            <td>₹${p.amount ? p.amount.toFixed(2) : '-'}</td>
            <td>${billBtn}</td>
          </tr>`;
        });
      }

      document.getElementById('totalAmount').textContent = `₹${paidTotal.toFixed(2)}`;

    } catch (error) {
      document.getElementById('studentInfo').textContent = 'Failed to load data: ' + error.message;
      console.error(error);
    }
  }

  const admissionNumber = getQueryParam('admissionNumber');
  loadStudentData(admissionNumber);
</script>
</body>
</html>
